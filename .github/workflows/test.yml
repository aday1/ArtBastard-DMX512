name: ğŸ§ª Build & Run Test - The Trials of ArtBastard

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
  schedule:
    # Run tests daily at midnight UTC to ensure nothing breaks
    - cron: '0 0 * * *'

jobs:
  build-test:
    name: ğŸ­ The Trials of Build
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ¬ Begin the Ritual
        run: |
          echo "ğŸ­ ArtBastard DMX512 - Build & Run Test"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "The trials begin... Let the photons flow!"
          echo ""
      
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: ğŸ“¦ Install root dependencies
        run: |
          echo "ğŸ“¦ Installing root dependencies..."
          npm ci --legacy-peer-deps
          echo "âœ… Root dependencies installed"
      
      - name: ğŸ“¦ Install frontend dependencies
        working-directory: ./react-app
        run: |
          echo "ğŸ“¦ Installing frontend dependencies..."
          npm ci --legacy-peer-deps
          echo "âœ… Frontend dependencies installed"
      
      - name: ğŸ—ï¸ Build backend
        run: |
          echo "ğŸ—ï¸ Building backend..."
          npm run build-backend
          echo "âœ… Backend build complete"
      
      - name: ğŸ—ï¸ Build frontend
        working-directory: ./react-app
        run: |
          echo "ğŸ—ï¸ Building frontend..."
          npm run build:vite
          echo "âœ… Frontend build complete"
      
      - name: ğŸ” Verify build artifacts
        run: |
          echo "ğŸ” Verifying build artifacts..."
          if [ ! -f "dist/server.js" ]; then
            echo "âŒ Backend build failed - dist/server.js not found"
            exit 1
          fi
          if [ ! -f "react-app/dist/index.html" ]; then
            echo "âŒ Frontend build failed - react-app/dist/index.html not found"
            exit 1
          fi
          echo "âœ… Build successful - all artifacts present"
          echo ""
          echo "ğŸ“Š Build Summary:"
          echo "  - Backend: âœ… dist/server.js"
          echo "  - Frontend: âœ… react-app/dist/index.html"
          ls -lh dist/server.js react-app/dist/index.html
      
      - name: ğŸš€ Test server startup
        run: |
          echo "ğŸš€ Testing server startup..."
          echo "Starting server with 5 second timeout..."
          timeout 5 node dist/server.js || true
          echo "âœ… Server starts successfully"
          echo ""
          echo "ğŸ­ All trials passed! ArtBastard is ready."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

